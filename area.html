<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Area Insights - Lendlord</title>
  <meta name="description" content="Local lettings & estate market intelligence. See agent density, average fees and reviews by postcode area.">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/styles.css">
</head>
<body>

  <header class="site-header" id="site-header"></header>

  <!-- Area Hero -->
  <section class="area-hero" id="area-hero">
    <div class="container">
      <div style="max-width:640px">
        <h1 id="area-title">Local Market Intelligence</h1>
        <p style="color:rgba(255,255,255,0.8);margin-top:var(--sp-2)" id="area-subtitle">
          Explore lettings & estate agent data by postcode area. See who operates where, average fees and agent quality.
        </p>
      </div>

      <!-- Search -->
      <div class="search-wrapper" style="max-width:480px;margin-top:var(--sp-6)">
        <div class="search-input-wrap" style="border-color:rgba(255,255,255,0.2)">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
          <input type="text" class="search-input" id="area-search" placeholder="Enter postcode area (e.g. SW1, B17, LS1)" autocomplete="off">
          <button class="search-btn" id="area-search-btn">Explore</button>
        </div>
        <div class="search-suggestions" id="area-suggestions"></div>
      </div>

      <!-- Stats (shown when area selected) -->
      <div class="area-stats-grid hidden" id="area-stats-grid"></div>
    </div>
  </section>

  <!-- Area Content -->
  <section class="section" style="padding-top:var(--sp-6)">
    <div class="container">

      <!-- Area insights panel (shown when area selected) -->
      <div id="area-insights-panel" style="display:none"></div>

      <!-- Top agents bar (shown when area selected) -->
      <div id="top-agents-bar" style="display:none"></div>

      <!-- Agent list (shown when area selected) -->
      <div id="area-agents" style="display:none">
        <div class="results-header" style="margin-bottom:var(--sp-4)">
          <span class="results-count" id="area-agent-count"></span>
          <div class="results-sort">
            <label for="area-sort">Sort by:</label>
            <select id="area-sort">
              <option value="trust">Trust Score</option>
              <option value="reviews">Most Reviews</option>
              <option value="rating">Highest Rated</option>
              <option value="has_fees">Has Fee Data</option>
              <option value="fees_low">Lowest Fees</option>
              <option value="years">Most Experienced</option>
              <option value="name">Name (A-Z)</option>
            </select>
          </div>
        </div>
        <div class="cards-grid" id="area-cards-grid"></div>
      </div>

      <!-- Nearby areas (shown when area selected) -->
      <div id="nearby-areas" style="display:none"></div>

      <!-- Popular areas (shown when no area selected) -->
      <div id="popular-areas">
        <div class="section-header" style="text-align:left;margin-bottom:var(--sp-6)">
          <h2>Popular Areas</h2>
          <p>Browse lettings & estate agent data by popular postcode areas</p>
        </div>
        <div class="features-grid" id="popular-grid"></div>
      </div>

      <!-- Recently viewed areas -->
      <div id="recent-areas" style="display:none">
        <div class="section-header" style="text-align:left;margin-bottom:var(--sp-4);margin-top:var(--sp-8)">
          <h2>Recently Viewed</h2>
        </div>
        <div class="features-grid" id="recent-grid"></div>
      </div>

    </div>
  </section>

  <footer class="site-footer" id="site-footer"></footer>

  <script type="module">
    import { loadData, getAreaStats, getNearbyAreas, sortResults, getSuggestions, getData } from './js/data.js';
    import { renderHeader, renderFooter, renderAuthModal, renderCardsGrid, initScrollTop, initTrustTooltip } from './js/ui.js';
    import { getParam, setParams, debounce, ICONS, fmtAgentType, lsGet, lsSet, trustScoreClass, starsHTML, initials } from './js/utils.js';
    import { initAuth, bindAuthEvents, isAuthenticated } from './js/auth.js';

    renderHeader('areas');
    renderFooter();
    renderAuthModal();
    initScrollTop();
    initTrustTooltip();
    await initAuth();
    bindAuthEvents();
    window.showAuthModal = () => document.getElementById('auth-modal').classList.add('open');
    window._isAuthenticated = isAuthenticated;

    const data = await loadData();
    const searchInput = document.getElementById('area-search');
    const suggestionsEl = document.getElementById('area-suggestions');

    const TYPE_LABELS = { high_street: 'High Street', online: 'Online', hybrid: 'Hybrid' };
    const CAT_LABELS = { letting: 'Lettings', estate: 'Estate', both: 'Both', unknown: 'Unknown' };
    const CAT_COLORS = { letting: 'var(--primary)', estate: 'var(--warning)', both: 'var(--accent)', unknown: 'var(--text-muted)' };

    // ── Recently viewed helper ──
    function getRecentAreas() { return lsGet('af_recent_areas', []); }
    function addRecentArea(outcode) {
      let recent = getRecentAreas().filter(a => a !== outcode);
      recent.unshift(outcode);
      if (recent.length > 8) recent = recent.slice(0, 8);
      lsSet('af_recent_areas', recent);
    }

    // ── Horizontal bar helper ──
    function hBar(label, value, total, color) {
      const pct = total ? Math.round((value / total) * 100) : 0;
      return `<div class="ai-hbar-row">
        <span class="ai-hbar-label">${label}</span>
        <div class="ai-hbar-track"><div class="ai-hbar-fill" style="width:${pct}%;background:${color}"></div></div>
        <span class="ai-hbar-val">${value} <span class="text-muted">(${pct}%)</span></span>
      </div>`;
    }

    // ── Popular area card ──
    function renderPopularCard(outcode, count) {
      const stats = getAreaStats(outcode);
      if (!stats) return '';
      const trustPct = Math.min(((stats.avgTrust - 50) / 50) * 100, 100);
      const trustColor = stats.avgTrust >= 75 ? 'var(--accent)' : stats.avgTrust >= 65 ? 'var(--warning)' : 'var(--text-muted)';
      const feesBadge = stats.withFees ? `<span class="badge badge-green text-xs">${stats.withFees} with fees</span>` : '';
      const catParts = Object.entries(stats.categories).filter(([k]) => k !== 'unknown').map(([k, v]) =>
        `<span class="text-xs" style="color:${CAT_COLORS[k] || 'inherit'}">${CAT_LABELS[k] || k}: ${v}</span>`
      ).join(' · ');

      return `
        <a href="area.html?postcode=${outcode}" class="feature-card area-popular-card" style="text-decoration:none;cursor:pointer">
          <div style="display:flex;align-items:center;justify-content:space-between">
            <h3 style="color:var(--primary);margin:0">${outcode}</h3>
            <span class="text-xs text-muted">${count} agent${count !== 1 ? 's' : ''}</span>
          </div>
          <div class="ai-mini-stats">
            <div class="ai-mini-stat">
              <span class="ai-mini-label">Trust</span>
              <div class="ai-mini-bar"><div style="width:${trustPct}%;background:${trustColor}"></div></div>
              <span class="ai-mini-val">${stats.avgTrust}</span>
            </div>
            ${stats.avgFee ? `<div class="ai-mini-stat">
              <span class="ai-mini-label">Fee</span>
              <span class="ai-mini-val font-semibold">${stats.avgFee}%</span>
            </div>` : ''}
            ${stats.avgRating ? `<div class="ai-mini-stat">
              <span class="ai-mini-label">Rating</span>
              <span class="ai-mini-val">${stats.avgRating}</span>
            </div>` : ''}
          </div>
          <div style="display:flex;align-items:center;gap:var(--sp-2);flex-wrap:wrap;margin-top:var(--sp-2)">
            ${feesBadge}
            ${stats.withArla ? `<span class="badge badge-blue text-xs">${stats.withArla} ARLA</span>` : ''}
          </div>
          ${catParts ? `<div style="margin-top:var(--sp-1)">${catParts}</div>` : ''}
        </a>`;
    }

    // ── Show popular areas ──
    function showPopularAreas() {
      const postcodeIndex = data.postcodeIndex;
      const sorted = Object.entries(postcodeIndex)
        .map(([outcode, ids]) => ({ outcode, count: ids.length }))
        .sort((a, b) => b.count - a.count)
        .slice(0, 12);

      document.getElementById('popular-grid').innerHTML = sorted.map(({ outcode, count }) =>
        renderPopularCard(outcode, count)
      ).join('');

      // Recently viewed
      showRecentAreas();
    }

    // ── Show recent areas ──
    function showRecentAreas() {
      const recent = getRecentAreas();
      const container = document.getElementById('recent-areas');
      if (!recent.length) { container.style.display = 'none'; return; }

      container.style.display = '';
      document.getElementById('recent-grid').innerHTML = recent
        .filter(o => data.postcodeIndex[o])
        .map(o => renderPopularCard(o, data.postcodeIndex[o].length))
        .join('');
    }

    // ── Build insights array ──
    function buildInsights(stats) {
      const insights = [];
      const { avgFee, nationalAvgFee, avgTrust, nationalAvgTrust, withArla, withFees, withCmp, agentCount, avgYears, outcode } = stats;

      if (avgFee && nationalAvgFee) {
        const diff = parseFloat(avgFee) - nationalAvgFee;
        if (diff < -1) insights.push({ icon: ICONS.trendUp, color: 'var(--accent)', text: `Average management fee in ${outcode} is <strong>${Math.abs(diff).toFixed(1)}% lower</strong> than the national average of ${nationalAvgFee}%` });
        else if (diff > 1) insights.push({ icon: ICONS.info, color: 'var(--warning)', text: `Average management fee in ${outcode} is <strong>${diff.toFixed(1)}% higher</strong> than the national average of ${nationalAvgFee}%` });
        else insights.push({ icon: ICONS.check, color: 'var(--accent)', text: `Management fees in ${outcode} are <strong>in line</strong> with the national average of ${nationalAvgFee}%` });
      }
      if (nationalAvgTrust && avgTrust) {
        if (avgTrust > nationalAvgTrust + 5) insights.push({ icon: ICONS.shieldCheck, color: 'var(--accent)', text: `Agent trust scores in ${outcode} are <strong>above average</strong> (${avgTrust} vs national ${nationalAvgTrust})` });
        else if (avgTrust < nationalAvgTrust - 5) insights.push({ icon: ICONS.info, color: 'var(--warning)', text: `Agent trust scores in ${outcode} are <strong>below average</strong> (${avgTrust} vs national ${nationalAvgTrust})` });
      }
      if (withArla && agentCount) {
        const pct = Math.round((withArla / agentCount) * 100);
        if (pct >= 40) insights.push({ icon: ICONS.shieldCheck, color: 'var(--accent)', text: `<strong>${pct}%</strong> of agents in ${outcode} are ARLA Propertymark members` });
      }
      if (withFees) insights.push({ icon: ICONS.pound, color: 'var(--primary)', text: `<strong>${withFees}</strong> of ${agentCount} agents have published fee data` });
      if (avgYears) insights.push({ icon: ICONS.clock, color: 'var(--text-secondary)', text: `Average branch age in ${outcode} is <strong>${avgYears} years</strong>` });

      return insights;
    }

    // ── Show area details ──
    function showArea(outcode) {
      outcode = outcode.toUpperCase().trim();
      const stats = getAreaStats(outcode);

      if (!stats) {
        document.getElementById('area-title').textContent = `No data for ${outcode}`;
        document.getElementById('area-subtitle').textContent = 'Try a different postcode area.';
        document.getElementById('area-stats-grid').classList.add('hidden');
        document.getElementById('area-agents').style.display = 'none';
        document.getElementById('area-insights-panel').style.display = 'none';
        document.getElementById('top-agents-bar').style.display = 'none';
        document.getElementById('nearby-areas').style.display = 'none';
        document.getElementById('popular-areas').style.display = '';
        document.getElementById('recent-areas').style.display = 'none';
        return;
      }

      addRecentArea(outcode);

      // Update hero
      document.getElementById('area-title').textContent = `${outcode} Area Insights`;
      document.getElementById('area-subtitle').textContent = `${stats.agentCount} lettings & estate agent${stats.agentCount !== 1 ? 's' : ''} operating in the ${outcode} postcode area`;
      document.title = `${outcode} Lettings & Estate Agents - Lendlord`;

      // ── Stats grid (expanded) ──
      const statsGrid = document.getElementById('area-stats-grid');
      statsGrid.classList.remove('hidden');
      statsGrid.innerHTML = `
        <div class="area-stat-card">
          <div class="stat-value">${stats.agentCount}</div>
          <div class="stat-label">Agents</div>
        </div>
        <div class="area-stat-card">
          <div class="stat-value">${stats.avgTrust} <span class="trust-info-trigger" data-trust-tooltip style="font-size:0.6rem;vertical-align:super">?</span></div>
          <div class="stat-label">Avg Trust Score</div>
        </div>
        <div class="area-stat-card">
          <div class="stat-value">${stats.avgFee ? stats.avgFee + '%' : 'N/A'}</div>
          <div class="stat-label">Avg Mgmt Fee</div>
        </div>
        <div class="area-stat-card">
          <div class="stat-value">${stats.avgRating || 'N/A'}</div>
          <div class="stat-label">Avg Rating</div>
        </div>
        <div class="area-stat-card">
          <div class="stat-value">${stats.avgYears || 'N/A'}</div>
          <div class="stat-label">Avg Years</div>
        </div>
        <div class="area-stat-card">
          <div class="stat-value">${stats.withFees}</div>
          <div class="stat-label">With Fee Data</div>
        </div>
        <div class="area-stat-card">
          <div class="stat-value">${stats.withArla}</div>
          <div class="stat-label">ARLA Members</div>
        </div>
        <div class="area-stat-card">
          <div class="stat-value">${stats.withReviews}</div>
          <div class="stat-label">With Reviews</div>
        </div>
      `;

      // ── Insights panel ──
      const insightsPanel = document.getElementById('area-insights-panel');
      const insights = buildInsights(stats);
      const typesTotal = stats.agentCount;
      const catsFiltered = Object.entries(stats.categories).filter(([k]) => k !== 'unknown');

      let breakdownHTML = '';
      // Agent type breakdown
      if (Object.keys(stats.agentTypes).length > 0) {
        breakdownHTML += `<div class="ai-breakdown-section">
          <div class="ai-breakdown-title">Agent Type</div>
          ${Object.entries(stats.agentTypes).map(([t, c]) => hBar(TYPE_LABELS[t] || t, c, typesTotal, 'var(--primary)')).join('')}
        </div>`;
      }
      // Category breakdown
      if (catsFiltered.length > 0) {
        breakdownHTML += `<div class="ai-breakdown-section">
          <div class="ai-breakdown-title">Category</div>
          ${catsFiltered.map(([k, v]) => hBar(CAT_LABELS[k] || k, v, typesTotal, CAT_COLORS[k] || 'var(--primary)')).join('')}
        </div>`;
      }
      // Fee range
      let feeRangeHTML = '';
      if (stats.minFee !== null && stats.maxFee !== null && stats.avgFee) {
        const range = stats.maxFee - stats.minFee;
        const avgPos = range > 0 ? ((parseFloat(stats.avgFee) - stats.minFee) / range * 100) : 50;
        feeRangeHTML = `<div class="ai-breakdown-section">
          <div class="ai-breakdown-title">Fee Range</div>
          <div class="ai-fee-range">
            <div class="ai-fee-range-track">
              <div class="ai-fee-range-marker" style="left:${avgPos}%" title="Area average: ${stats.avgFee}%"></div>
            </div>
            <div class="ai-fee-range-labels">
              <span>${stats.minFee}%</span>
              <span class="font-semibold" style="color:var(--primary)">Avg ${stats.avgFee}%</span>
              <span>${stats.maxFee}%</span>
            </div>
          </div>
        </div>`;
      }

      if (insights.length || breakdownHTML || feeRangeHTML) {
        insightsPanel.style.display = '';
        insightsPanel.innerHTML = `
          <div class="ai-panel">
            ${insights.length ? `<div class="ai-insights">
              ${insights.map(i => `<div class="ai-insight-item">
                <span class="ai-insight-icon" style="color:${i.color}">${i.icon}</span>
                <span class="text-sm">${i.text}</span>
              </div>`).join('')}
            </div>` : ''}
            ${breakdownHTML || feeRangeHTML ? `<div class="ai-breakdowns">${breakdownHTML}${feeRangeHTML}</div>` : ''}
          </div>`;
      } else {
        insightsPanel.style.display = 'none';
      }

      // ── Top 3 agents ──
      const topBar = document.getElementById('top-agents-bar');
      if (stats.topAgents.length) {
        topBar.style.display = '';
        topBar.innerHTML = `
          <div class="ai-top-agents">
            <div class="ai-top-title">${ICONS.award} Top Agents in ${outcode}</div>
            <div class="ai-top-grid">
              ${stats.topAgents.map((a, i) => {
                const logo = a.logo
                  ? `<img src="${a.logo}" alt="" class="ai-top-logo" onerror="this.outerHTML='<div class=\\'ai-top-logo-placeholder\\'>${initials(a.name)}</div>'">`
                  : `<div class="ai-top-logo-placeholder">${initials(a.name)}</div>`;
                return `<a href="agent.html?id=${a.id}" class="ai-top-card">
                  <div class="ai-top-rank">#${i + 1}</div>
                  ${logo}
                  <div class="ai-top-info">
                    <div class="font-semibold text-sm" style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${a.name}</div>
                    <div style="display:flex;align-items:center;gap:var(--sp-2)">
                      <div class="trust-score ${trustScoreClass(a.trust_score)} trust-score-sm">${a.trust_score}</div>
                      ${a.reviews.avg ? `<span class="text-xs text-muted">${a.reviews.avg} rating</span>` : ''}
                    </div>
                  </div>
                </a>`;
              }).join('')}
            </div>
          </div>`;
      } else {
        topBar.style.display = 'none';
      }

      // ── Agents list ──
      document.getElementById('popular-areas').style.display = 'none';
      document.getElementById('recent-areas').style.display = 'none';
      document.getElementById('area-agents').style.display = '';
      document.getElementById('area-agent-count').innerHTML = `<strong>${stats.agentCount}</strong> agents in ${outcode}`;

      renderCardsGrid(stats.agents, 'area-cards-grid');

      // Sort (remove old listener by cloning)
      const sortEl = document.getElementById('area-sort');
      const newSort = sortEl.cloneNode(true);
      sortEl.parentNode.replaceChild(newSort, sortEl);
      newSort.addEventListener('change', (e) => {
        const sorted = sortResults(stats.agents, e.target.value);
        renderCardsGrid(sorted, 'area-cards-grid');
      });

      // ── Nearby areas ──
      const nearbyContainer = document.getElementById('nearby-areas');
      const nearby = getNearbyAreas(outcode, 6);
      if (nearby.length) {
        nearbyContainer.style.display = '';
        nearbyContainer.innerHTML = `
          <div style="margin-top:var(--sp-8)">
            <div class="section-header" style="text-align:left;margin-bottom:var(--sp-4)">
              <h2>Nearby Areas</h2>
              <p>Other postcode areas in the ${outcode.replace(/[0-9]/g, '')} region</p>
            </div>
            <div class="features-grid">
              ${nearby.map(n => renderPopularCard(n.outcode, n.count)).join('')}
            </div>
          </div>`;
      } else {
        nearbyContainer.style.display = 'none';
      }
    }

    // ── Search ──
    function doSearch() {
      const val = searchInput.value.trim();
      if (val) {
        setParams({ postcode: val.toUpperCase() });
        showArea(val);
      }
    }

    document.getElementById('area-search-btn').addEventListener('click', doSearch);
    searchInput.addEventListener('keydown', e => {
      if (e.key === 'Enter') doSearch();
      if (e.key === 'Escape') suggestionsEl.classList.remove('open');
    });

    // ── Enhanced suggestions ──
    const showSugg = debounce(val => {
      if (val.length < 1) { suggestionsEl.classList.remove('open'); return; }
      const q = val.toUpperCase();
      const matches = Object.keys(data.postcodeIndex)
        .filter(k => k.startsWith(q))
        .sort((a, b) => data.postcodeIndex[b].length - data.postcodeIndex[a].length)
        .slice(0, 8)
        .map(k => {
          const s = getAreaStats(k);
          return { text: k, count: data.postcodeIndex[k].length, avgTrust: s ? s.avgTrust : null, avgFee: s ? s.avgFee : null, withFees: s ? s.withFees : 0 };
        });

      if (!matches.length) { suggestionsEl.classList.remove('open'); return; }
      suggestionsEl.innerHTML = matches.map(m => `
        <div class="suggestion-item" data-value="${m.text}">
          <div style="display:flex;align-items:center;gap:var(--sp-2)">
            <span class="font-semibold">${m.text}</span>
            <span class="text-xs text-muted">${m.count} agents</span>
          </div>
          <div style="display:flex;align-items:center;gap:var(--sp-2)">
            ${m.avgTrust ? `<span class="text-xs text-muted">Trust: ${m.avgTrust}</span>` : ''}
            ${m.avgFee ? `<span class="text-xs text-muted">Fee: ${m.avgFee}%</span>` : ''}
            ${m.withFees ? `<span class="badge badge-green text-xs" style="padding:1px 6px">${m.withFees} fees</span>` : ''}
          </div>
        </div>
      `).join('');
      suggestionsEl.classList.add('open');

      suggestionsEl.querySelectorAll('.suggestion-item').forEach(item => {
        item.addEventListener('click', () => {
          searchInput.value = item.dataset.value;
          suggestionsEl.classList.remove('open');
          doSearch();
        });
      });
    }, 150);
    searchInput.addEventListener('input', e => showSugg(e.target.value));
    document.addEventListener('click', e => {
      if (!e.target.closest('.search-wrapper')) suggestionsEl.classList.remove('open');
    });

    // ── Init ──
    const postcodeParam = getParam('postcode');
    if (postcodeParam) {
      searchInput.value = postcodeParam;
      showArea(postcodeParam);
    } else {
      showPopularAreas();
    }
  </script>

</body>
</html>
