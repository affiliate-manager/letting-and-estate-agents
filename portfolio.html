<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Portfolio Manager - Lendlord</title>
  <meta name="description" content="Manage multiple properties and find the best lettings agent across your entire portfolio.">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/styles.css">
</head>
<body>

  <header class="site-header" id="site-header"></header>

  <section style="background:var(--surface);border-bottom:1px solid var(--border-light);padding:var(--sp-6) 0">
    <div class="container">
      <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:var(--sp-4)">
        <div>
          <h1 style="font-size:1.75rem">Portfolio Manager</h1>
          <p class="text-secondary">Add your properties and find agents who cover your entire portfolio</p>
        </div>
        <button class="btn btn-primary" id="add-property-btn">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:18px;height:18px"><path d="M5 12h14"/><path d="M12 5v14"/></svg>
          Add Property
        </button>
      </div>
    </div>
  </section>

  <!-- Auth gate -->
  <div id="auth-gate" class="section" style="display:none">
    <div class="container" style="text-align:center">
      <div class="empty-state">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:64px;height:64px;opacity:0.4"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
        <h3>Sign in to manage your portfolio</h3>
        <p>Create a free account to save properties, track agents and get personalised recommendations</p>
        <button class="btn btn-primary btn-lg" style="margin-top:var(--sp-4)" onclick="window.showAuthModal && window.showAuthModal()">Sign Up Free</button>
      </div>
    </div>
  </div>

  <!-- Portfolio content -->
  <section class="section" id="portfolio-content" style="display:none;padding-top:var(--sp-6)">
    <div class="container">

      <!-- Properties grid -->
      <div class="portfolio-grid" id="properties-grid"></div>

      <!-- Universal agents section -->
      <div id="universal-section" style="display:none;margin-top:var(--sp-10)">
        <div style="margin-bottom:var(--sp-6)">
          <h2>Agents Covering Your Entire Portfolio</h2>
          <p class="text-secondary">These agents operate in all your property areas</p>
        </div>
        <div class="cards-grid" id="universal-agents-grid"></div>
      </div>

      <!-- Fee calculator -->
      <div id="fee-calc" style="display:none;margin-top:var(--sp-10)">
        <div class="data-card" style="max-width:640px">
          <div class="data-card-title">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:18px;height:18px;color:var(--primary)"><path d="M18 7c0-5.333-8-5.333-8 0v8.5c0 2-2 3.5-4 3.5h12"/><path d="M6 15h8"/></svg>
            Fee Consolidation Calculator
          </div>
          <p class="text-sm text-secondary" style="margin-bottom:var(--sp-4)">See how much you could save by consolidating all properties under one agent</p>
          <div id="fee-calc-results"></div>
        </div>
      </div>
    </div>
  </section>

  <!-- Add Property Modal -->
  <div class="modal-backdrop" id="add-property-modal">
    <div class="modal">
      <button class="modal-close" onclick="document.getElementById('add-property-modal').classList.remove('open')">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:18px;height:18px"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
      </button>
      <h2>Add Property</h2>
      <p class="text-secondary" style="margin-bottom:var(--sp-5)">Enter your property's postcode to find agents in that area</p>
      <form id="add-property-form">
        <div class="form-group">
          <label class="form-label" for="prop-name">Property Name (optional)</label>
          <input class="form-input" type="text" id="prop-name" placeholder="e.g. 42 Baker Street">
        </div>
        <div class="form-group">
          <label class="form-label" for="prop-postcode">Postcode *</label>
          <input class="form-input" type="text" id="prop-postcode" placeholder="e.g. SW1A 1AA" required>
        </div>
        <button type="submit" class="btn btn-primary" style="width:100%">Add Property</button>
      </form>
    </div>
  </div>

  <footer class="site-footer" id="site-footer"></footer>

  <script type="module">
    import { loadData, searchAgents, getAgent, getData } from './js/data.js';
    import { renderHeader, renderFooter, renderAuthModal, renderCardsGrid, initScrollTop, initTrustTooltip } from './js/ui.js';
    import { lsGet, lsSet, showToast, ICONS } from './js/utils.js';
    import { initAuth, bindAuthEvents, isAuthenticated } from './js/auth.js';

    renderHeader('portfolio');
    renderFooter();
    renderAuthModal();
    initScrollTop();
    initTrustTooltip();
    await initAuth();
    bindAuthEvents();
    window.showAuthModal = () => document.getElementById('auth-modal').classList.add('open');
    window._isAuthenticated = isAuthenticated;

    const data = await loadData();

    // Portfolio state (stored in localStorage)
    let properties = lsGet('af_portfolio', []);

    // Check auth
    function checkAuth() {
      const authed = isAuthenticated();
      document.getElementById('auth-gate').style.display = authed ? 'none' : '';
      document.getElementById('portfolio-content').style.display = authed ? '' : 'none';
    }
    checkAuth();

    // Render properties
    function renderProperties() {
      const grid = document.getElementById('properties-grid');

      let html = properties.map((prop, i) => {
        const agents = searchAgents(prop.postcode);
        const topAgent = agents[0];
        return `
          <div class="property-card">
            <div style="display:flex;justify-content:space-between;align-items:flex-start">
              <div>
                <h3 style="font-size:1rem">${prop.name || prop.postcode}</h3>
                <div class="text-sm text-muted" style="display:flex;align-items:center;gap:4px">
                  ${ICONS.mapPin} ${prop.postcode}
                </div>
              </div>
              <button class="btn btn-ghost btn-icon" onclick="removeProperty(${i})">
                ${ICONS.trash}
              </button>
            </div>
            <div style="padding:var(--sp-3);background:var(--bg);border-radius:var(--radius-sm)">
              <div class="text-xs text-muted" style="margin-bottom:4px">AGENTS FOUND</div>
              <div class="font-bold" style="font-size:1.25rem">${agents.length}</div>
            </div>
            ${topAgent ? `
              <div class="text-xs text-muted">Best match:</div>
              <div style="display:flex;align-items:center;gap:var(--sp-2)">
                <div class="trust-score-wrap">
                  <div class="trust-score ${topAgent.trust_score >= 80 ? 'score-high' : topAgent.trust_score >= 68 ? 'score-mid' : 'score-low'} trust-score-sm">${topAgent.trust_score}</div>
                  <span class="trust-score-label">Trust <span class="trust-info-trigger" data-trust-tooltip>?</span></span>
                </div>
                <span class="text-sm font-semibold">${topAgent.name}</span>
              </div>
            ` : ''}
            <a href="results.html?q=${encodeURIComponent(prop.postcode)}" class="btn btn-outline btn-sm" style="width:100%">View All Agents</a>
          </div>
        `;
      }).join('');

      // Add property card
      html += `
        <div class="add-property-card" onclick="document.getElementById('add-property-modal').classList.add('open')">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:32px;height:32px"><path d="M5 12h14"/><path d="M12 5v14"/></svg>
          <span class="font-semibold">Add Property</span>
        </div>
      `;

      grid.innerHTML = html;

      // Find universal agents
      findUniversalAgents();
    }

    // Find agents covering all properties
    function findUniversalAgents() {
      const section = document.getElementById('universal-section');
      if (properties.length < 2) {
        section.style.display = 'none';
        return;
      }

      // Get agents for each property
      const agentSets = properties.map(p => new Set(searchAgents(p.postcode).map(a => a.id)));

      // Find intersection
      let universal = agentSets[0];
      for (let i = 1; i < agentSets.length; i++) {
        universal = new Set([...universal].filter(id => agentSets[i].has(id)));
      }

      if (universal.size === 0) {
        section.style.display = 'block';
        document.getElementById('universal-agents-grid').innerHTML = `
          <div class="empty-state" style="grid-column:1/-1">
            <h3>No universal agents found</h3>
            <p>No single agent covers all your property areas. Consider viewing agents per property.</p>
          </div>
        `;
        return;
      }

      const universalAgents = [...universal].map(id => getAgent(id)).filter(Boolean)
        .sort((a, b) => b.trust_score - a.trust_score);

      section.style.display = 'block';
      renderCardsGrid(universalAgents, 'universal-agents-grid', true);

      // Fee calculator
      showFeeCalc(universalAgents);
    }

    // Fee consolidation calculator
    function showFeeCalc(agents) {
      const calc = document.getElementById('fee-calc');
      const topAgents = agents.filter(a => a.fees.mgmt_pct).slice(0, 3);

      if (!topAgents.length || properties.length < 2) {
        calc.style.display = 'none';
        return;
      }

      calc.style.display = 'block';
      const avgRent = 1200; // Assume average rent
      const numProps = properties.length;

      document.getElementById('fee-calc-results').innerHTML = topAgents.map(a => {
        const monthly = (a.fees.mgmt_pct / 100) * avgRent * numProps;
        const yearly = monthly * 12;
        return `
          <div style="display:flex;justify-content:space-between;align-items:center;padding:var(--sp-3);border-bottom:1px solid var(--border-light)">
            <div>
              <div class="font-semibold">${a.name}</div>
              <div class="text-xs text-muted">${a.fees.mgmt_pct}% management fee</div>
            </div>
            <div style="text-align:right">
              <div class="font-bold">~${Math.round(yearly).toLocaleString()}/yr</div>
              <div class="text-xs text-muted">for ${numProps} properties at ${avgRent}/mo avg</div>
            </div>
          </div>
        `;
      }).join('') + `<p class="text-xs text-muted" style="margin-top:var(--sp-3)">Estimates based on assumed average rent of ${avgRent}/month. Actual fees may vary.</p>`;
    }

    // Remove property
    window.removeProperty = (index) => {
      properties.splice(index, 1);
      lsSet('af_portfolio', properties);
      renderProperties();
      showToast('Property removed');
    };

    // Add property form
    document.getElementById('add-property-form').addEventListener('submit', (e) => {
      e.preventDefault();
      const name = document.getElementById('prop-name').value.trim();
      const postcode = document.getElementById('prop-postcode').value.trim().toUpperCase();

      if (!postcode) return;

      properties.push({ name: name || postcode, postcode });
      lsSet('af_portfolio', properties);
      renderProperties();

      document.getElementById('prop-name').value = '';
      document.getElementById('prop-postcode').value = '';
      document.getElementById('add-property-modal').classList.remove('open');
      showToast('Property added');
    });

    // Add property button
    document.getElementById('add-property-btn').addEventListener('click', () => {
      if (!isAuthenticated()) {
        window.showAuthModal();
        return;
      }
      document.getElementById('add-property-modal').classList.add('open');
    });

    // Close modal on backdrop
    document.getElementById('add-property-modal').addEventListener('click', (e) => {
      if (e.target.id === 'add-property-modal') e.target.classList.remove('open');
    });

    // Initial render
    if (isAuthenticated()) {
      renderProperties();
    }
  </script>

</body>
</html>
