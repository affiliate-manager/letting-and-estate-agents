<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Compare Lettings & Estate Agents - Lendlord</title>
  <meta name="description" content="Compare lettings & estate agents side by side. Fees, services, reviews and regulatory compliance.">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/styles.css">
</head>
<body>

  <header class="site-header" id="site-header"></header>

  <section class="compare-header">
    <div class="container">
      <h1 style="margin-bottom:var(--sp-2)">Compare Lettings & Estate Agents</h1>
      <p class="text-secondary">Select up to 3 agents to compare fees, services and performance side by side</p>

      <div class="compare-agents" id="compare-slots" style="margin-top:var(--sp-6)">
        <!-- Filled by JS -->
      </div>
    </div>
  </section>

  <section class="section" style="padding-top:var(--sp-6)">
    <div class="container">
      <div id="sample-banner" class="card" style="display:none;background:var(--primary-bg);border:1px solid var(--primary);margin-bottom:var(--sp-4);padding:var(--sp-3) var(--sp-4);border-radius:var(--radius)">
        <div style="display:flex;align-items:center;gap:var(--sp-3);flex-wrap:wrap">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="2" style="width:20px;height:20px;flex-shrink:0"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>
          <span class="text-sm" style="flex:1"><strong>Sample comparison</strong> — showing 3 random agents with fee data. Search above to compare your own agents.</span>
          <button class="btn btn-outline btn-sm" id="clear-sample-btn">Clear &amp; Start Fresh</button>
        </div>
      </div>

      <!-- Search to add agents -->
      <div id="add-agent-section" style="margin-bottom:var(--sp-4)">
        <div class="search-wrapper" style="max-width:480px">
          <div class="search-input-wrap">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
            <input type="text" class="search-input" id="agent-search" placeholder="Search agent by address, postcode, name..." autocomplete="off">
          </div>
          <div class="search-suggestions" id="agent-suggestions"></div>
        </div>
      </div>

      <!-- Smart Filters -->
      <div id="smart-filters" class="cf-filters-wrap">
        <div class="cf-filters-bar">
          <span class="cf-filters-label">Filters:</span>

          <!-- Location -->
          <div class="cf-chip-wrap">
            <button class="cf-chip" data-filter="location">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>
              <span>Location</span>
              <svg class="cf-caret" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m6 9 6 6 6-6"/></svg>
            </button>
            <div class="cf-dropdown cf-dropdown-loc" id="dd-location">
              <input type="text" class="cf-dd-search" id="loc-search" placeholder="Type postcode, city or area name..." autocomplete="off">
              <div class="cf-dd-list" id="loc-list"></div>
            </div>
          </div>

          <!-- Trust Score -->
          <div class="cf-chip-wrap">
            <button class="cf-chip" data-filter="trust">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
              <span>Trust Score</span>
              <svg class="cf-caret" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m6 9 6 6 6-6"/></svg>
            </button>
            <div class="cf-dropdown" id="dd-trust">
              <label class="cf-dd-radio"><input type="radio" name="cf-trust" value="" checked> Any</label>
              <label class="cf-dd-radio"><input type="radio" name="cf-trust" value="70"> 70+</label>
              <label class="cf-dd-radio"><input type="radio" name="cf-trust" value="80"> 80+</label>
              <label class="cf-dd-radio"><input type="radio" name="cf-trust" value="90"> 90+</label>
            </div>
          </div>

          <!-- Toggle chips -->
          <button class="cf-chip cf-toggle" data-filter="hasFees">Has Fee Data</button>
          <button class="cf-chip cf-toggle" data-filter="hasReviews">Has Reviews</button>
          <button class="cf-chip cf-toggle" data-filter="arla">ARLA</button>
          <button class="cf-chip cf-toggle" data-filter="cmp">CMP</button>

          <!-- Category -->
          <div class="cf-chip-wrap">
            <button class="cf-chip" data-filter="category">
              <span>Category</span>
              <svg class="cf-caret" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m6 9 6 6 6-6"/></svg>
            </button>
            <div class="cf-dropdown" id="dd-category">
              <label class="cf-dd-radio"><input type="radio" name="cf-cat" value="" checked> Any</label>
              <label class="cf-dd-radio"><input type="radio" name="cf-cat" value="letting"> Lettings</label>
              <label class="cf-dd-radio"><input type="radio" name="cf-cat" value="estate"> Estate</label>
              <label class="cf-dd-radio"><input type="radio" name="cf-cat" value="both"> Both</label>
            </div>
          </div>

          <!-- Experience -->
          <div class="cf-chip-wrap">
            <button class="cf-chip" data-filter="experience">
              <span>Experience</span>
              <svg class="cf-caret" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m6 9 6 6 6-6"/></svg>
            </button>
            <div class="cf-dropdown" id="dd-experience">
              <label class="cf-dd-radio"><input type="radio" name="cf-exp" value="" checked> Any</label>
              <label class="cf-dd-radio"><input type="radio" name="cf-exp" value="growing"> Growing</label>
              <label class="cf-dd-radio"><input type="radio" name="cf-exp" value="established"> Established</label>
              <label class="cf-dd-radio"><input type="radio" name="cf-exp" value="veteran"> Veteran</label>
            </div>
          </div>

          <button class="cf-chip cf-clear" id="cf-clear-all" style="display:none">Clear All</button>
        </div>

        <!-- Filtered results -->
        <div id="cf-results-panel" style="display:none">
          <div class="cf-results-header">
            <span id="cf-results-count">0 agents match</span>
            <div class="cf-results-sort">
              <label>Sort:</label>
              <select id="cf-sort">
                <option value="trust">Trust Score</option>
                <option value="rating">Rating</option>
                <option value="name">Name</option>
                <option value="fees">Lowest Fee</option>
              </select>
            </div>
          </div>
          <div class="cf-results-grid" id="cf-results-grid">
            <!-- Agent cards rendered by JS -->
          </div>
          <div id="cf-results-more" style="display:none;text-align:center;padding:var(--sp-3)">
            <button class="btn btn-outline btn-sm" id="cf-show-more">Show more</button>
          </div>
        </div>
        <div id="cf-slots-full" class="cf-slots-full-msg" style="display:none">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px"><path d="m9 12 2 2 4-4"/><circle cx="12" cy="12" r="10"/></svg>
          <span>All 3 comparison slots are filled. Remove an agent to add another.</span>
        </div>
      </div>

      <!-- Comparison Table -->
      <div id="compare-content" style="display:none">
        <div style="overflow-x:auto;-webkit-overflow-scrolling:touch">
          <table class="compare-table" id="compare-table">
            <tbody id="compare-tbody"></tbody>
          </table>
        </div>
      </div>

      <div id="compare-empty" class="empty-state">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:64px;height:64px;opacity:0.4"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="16"/></svg>
        <h3>Add agents to compare</h3>
        <p>Search for agents above or select them from the search results page</p>
      </div>
    </div>
  </section>

  <footer class="site-footer" id="site-footer"></footer>

  <script type="module">
    import { loadData, getAgent, getData } from './js/data.js';
    import { renderHeader, renderFooter, renderAuthModal, initScrollTop, initTrustTooltip } from './js/ui.js';
    import { getParam, lsGet, lsSet, debounce, ICONS, trustScoreClass, starsHTML, reviewPlatformsHTML, fmtFee, fmtAgentType, initials, portalBadgesHTML, naeaBadgeHTML } from './js/utils.js';
    import { initAuth, bindAuthEvents } from './js/auth.js';

    renderHeader('compare');
    renderFooter();
    renderAuthModal();
    initScrollTop();
    initTrustTooltip();
    await initAuth();
    bindAuthEvents();
    window.showAuthModal = () => document.getElementById('auth-modal').classList.add('open');

    const data = await loadData();

    // Get compare list from URL or localStorage
    let compareIds = [];
    let isSample = false;
    const idsParam = getParam('ids');
    if (idsParam) {
      compareIds = idsParam.split(',').map(Number).filter(id => !isNaN(id) && getAgent(id));
    } else {
      compareIds = lsGet('af_compare', []);
    }

    // If no agents selected, show a sample comparison of 3 random agents with fee data
    if (compareIds.length === 0 && data && data.agents) {
      const agentsWithFees = data.agents.filter(a =>
        a.fees && (a.fees.tenant_find || a.fees.full_management || a.fees.mgmt_pct || a.fees.detail)
      );
      if (agentsWithFees.length >= 3) {
        const shuffled = agentsWithFees.sort(() => Math.random() - 0.5);
        compareIds = shuffled.slice(0, 3).map(a => a.id);
        isSample = true;
      }
    }

    function renderSlots() {
      const slotsEl = document.getElementById('compare-slots');
      let html = '';

      for (let i = 0; i < 3; i++) {
        if (i < compareIds.length) {
          const agent = getAgent(compareIds[i]);
          const logo = agent.logo
            ? `<img src="${agent.logo}" alt="" style="width:40px;height:40px;border-radius:8px;object-fit:contain;background:var(--bg);padding:2px" onerror="this.style.display='none'">`
            : `<div style="width:40px;height:40px;border-radius:8px;background:var(--primary-bg);display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--primary)">${initials(agent.name)}</div>`;
          html += `
            <div class="compare-slot filled">
              <div style="display:flex;align-items:center;gap:var(--sp-3);width:100%">
                ${logo}
                <div style="flex:1;min-width:0">
                  <div class="font-semibold text-sm" style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${agent.name}</div>
                  <div class="text-xs text-muted">${agent.postcode || ''}</div>
                </div>
                <button class="btn btn-ghost btn-icon" onclick="removeAgent(${i})" style="flex-shrink:0">
                  ${ICONS.x}
                </button>
              </div>
            </div>`;
        } else {
          html += `
            <div class="compare-slot" onclick="document.getElementById('agent-search').focus()">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:24px;height:24px;margin-bottom:8px"><path d="M5 12h14"/><path d="M12 5v14"/></svg>
              <span class="text-sm">Add Agent</span>
            </div>`;
        }
      }
      slotsEl.innerHTML = html;
    }

    function renderComparison() {
      if (compareIds.length < 2) {
        document.getElementById('compare-content').style.display = 'none';
        document.getElementById('compare-empty').style.display = '';
        return;
      }
      document.getElementById('compare-content').style.display = '';
      document.getElementById('compare-empty').style.display = 'none';

      const agents = compareIds.map(id => getAgent(id));
      const tbody = document.getElementById('compare-tbody');

      const rows = [
        { label: 'Trust Score', fn: a => `<div class="trust-score-wrap"><div class="trust-score ${trustScoreClass(a.trust_score)} trust-score-sm">${a.trust_score}</div><span class="trust-score-label">Trust <span class="trust-info-trigger" data-trust-tooltip>?</span></span></div>` },
        { label: 'Rating', fn: a => starsHTML(a.reviews.avg, a.reviews.count) + reviewPlatformsHTML(a.reviews) },
        { label: 'Agent Type', fn: a => fmtAgentType(a.agent_type) || '-' },
        { label: 'Management Fee', fn: a => a.fees.full_management || (a.fees.mgmt_pct ? a.fees.mgmt_pct + '%' : '-') },
        { label: 'Tenant Find Fee', fn: a => a.fees.tenant_find || '-' },
        { label: 'Guaranteed Rent', fn: a => a.fees.guaranteed_rent || (a.guaranteed_rent ? 'Available' : '-') },
        { label: 'Rent Collection', fn: a => a.fees.rent_collection || '-' },
        { label: 'Minimum Fee', fn: a => a.fees.minimum || '-' },
        { label: 'No Tenant Fees', fn: a => a.fees.no_tenant_fees ? `<span class="badge badge-green">Yes</span>` : '-' },
        { label: 'VAT Inclusive', fn: a => a.fees.vat_inclusive === true ? 'Yes' : a.fees.vat_inclusive === false ? 'No' : '-' },
        { label: 'Renewal Fee', fn: a => a.fees.renewal ? `<span class="hidden-fees-inline">${a.fees.renewal}</span>` : '<span class="text-muted">None</span>' },
        { label: 'Setup Fee', fn: a => a.fees.setup ? `<span class="hidden-fees-inline">${a.fees.setup}</span>` : '<span class="text-muted">None</span>' },
        { label: 'Additional Fees', fn: a => {
          const extras = [a.fees.renewal, a.fees.setup, a.fees.inventory].filter(Boolean);
          return extras.length ? `<span class="badge badge-amber">${extras.length} extra fee${extras.length > 1 ? 's' : ''}</span>` : `<span class="badge badge-green">No extra fees</span>`;
        }},
        { label: 'Service Tiers', fn: a => a.service_tiers.length ? a.service_tiers.join(', ') : '-' },
        { label: 'ARLA', fn: a => a.regulatory.arla ? `<span class="badge badge-green">Yes</span>` : a.regulatory.arla === false ? `<span class="badge badge-red">No</span>` : '-' },
        { label: 'NAEA', fn: a => a.regulatory.naea ? `<span class="badge badge-green">Yes</span>` : a.regulatory.naea === false ? `<span class="badge badge-red">No</span>` : '-' },
        { label: 'Client Money Protection', fn: a => a.regulatory.cmp ? `<span class="badge badge-green">Yes</span>` : a.regulatory.cmp === false ? `<span class="badge badge-red">No</span>` : '-' },
        { label: 'Property Ombudsman', fn: a => a.regulatory.tpo ? `<span class="badge badge-green">Yes</span>` : a.regulatory.tpo === false ? `<span class="badge badge-red">No</span>` : '-' },
        { label: 'PI Insurance', fn: a => a.regulatory.pi_insurance ? `<span class="badge badge-green">Yes</span>` : a.regulatory.pi_insurance === false ? `<span class="badge badge-red">No</span>` : '-' },
        { label: 'Deposit Protection', fn: a => a.regulatory.deposit || '-' },
        { label: 'Years in Business', fn: a => a.performance.years || '-' },
        { label: 'Offices', fn: a => a.performance.offices || '-' },
        { label: 'Properties Listed', fn: a => a.performance.listed || '-' },
        { label: 'Under Management', fn: a => a.performance.managed ? a.performance.managed.toLocaleString() : '-' },
        { label: 'Avg Time to Let', fn: a => a.performance.avg_time_to_let ? a.performance.avg_time_to_let + ' days' : '-' },
        { label: 'Portals', fn: a => a.portals.length ? portalBadgesHTML(a.portals, 'sm') : '-' },
        { label: 'Areas Covered', fn: a => a.areas.length ? a.areas.slice(0, 5).join(', ') : '-' },
        { label: 'Social Media', fn: a => {
          const count = Object.values(a.social).filter(Boolean).length;
          return count ? `${count} channel${count > 1 ? 's' : ''}` : '-';
        }},
        { label: 'Activity', fn: a => a.activity === 'active' ? '<span class="badge badge-green">Active</span>' : a.activity === 'moderate' ? '<span class="badge badge-amber">Moderate</span>' : '<span class="badge badge-gray">Low</span>' },
      ];

      // Header row
      let html = `<tr><th style="min-width:160px">Metric</th>${agents.map(a =>
        `<td style="text-align:center;font-weight:700">${a.name}<br><a href="agent.html?id=${a.id}" class="text-xs" style="font-weight:400">View Profile</a></td>`
      ).join('')}</tr>`;

      rows.forEach(row => {
        const values = agents.map(a => row.fn(a));
        html += `<tr><th>${row.label}</th>${values.map(v => `<td>${v}</td>`).join('')}</tr>`;
      });

      tbody.innerHTML = html;
    }

    // Agent search with rich autocomplete
    const searchInput = document.getElementById('agent-search');
    const suggestionsEl = document.getElementById('agent-suggestions');

    const SICONS = {
      pin:      '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>',
      map:      '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"/><line x1="8" y1="2" x2="8" y2="18"/><line x1="16" y1="6" x2="16" y2="22"/></svg>',
      building: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="4" y="2" width="16" height="20" rx="2"/><path d="M9 22v-4h6v4"/><path d="M8 6h.01"/><path d="M16 6h.01"/><path d="M12 6h.01"/><path d="M12 10h.01"/><path d="M12 14h.01"/><path d="M16 10h.01"/><path d="M16 14h.01"/><path d="M8 10h.01"/><path d="M8 14h.01"/></svg>',
      home:     '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>',
    };

    function findAgentMatches(val) {
      if (val.length < 2) return [];
      const q = val.trim();
      const qLower = q.toLowerCase();
      const qUpper = q.toUpperCase();
      const results = [];
      const seenIds = new Set(compareIds);

      // 1 — Match by postcode/outcode prefix
      if (data.postcodeIndex) {
        for (const [outcode, ids] of Object.entries(data.postcodeIndex)) {
          if (outcode.startsWith(qUpper)) {
            for (const id of ids) {
              if (!seenIds.has(id) && results.length < 20) {
                results.push({ agent: data.agents[id], via: 'postcode', viaLabel: outcode });
                seenIds.add(id);
              }
            }
          }
        }
      }

      // 2 — Match by area name
      if (data.areaIndex) {
        for (const [area, ids] of Object.entries(data.areaIndex)) {
          const match = qLower.length <= 3
            ? area.startsWith(qLower) || area.includes(' ' + qLower)
            : area.includes(qLower);
          if (match) {
            for (const id of ids) {
              if (!seenIds.has(id) && results.length < 20) {
                const titleArea = area.replace(/\b\w/g, c => c.toUpperCase());
                results.push({ agent: data.agents[id], via: 'area', viaLabel: titleArea });
                seenIds.add(id);
              }
            }
          }
        }
      }

      // 3 — Match by agent name
      for (const agent of data.agents) {
        if (seenIds.has(agent.id)) continue;
        if (agent.name && agent.name.toLowerCase().includes(qLower)) {
          results.push({ agent, via: 'name', viaLabel: '' });
          seenIds.add(agent.id);
        }
        if (results.length >= 20) break;
      }

      // 4 — Match by address
      for (const agent of data.agents) {
        if (seenIds.has(agent.id)) continue;
        if (agent.address && agent.address.toLowerCase().includes(qLower)) {
          const parts = agent.address.split(',').map(p => p.trim()).filter(Boolean);
          const addrSnippet = parts.slice(0, 2).join(', ');
          results.push({ agent, via: 'address', viaLabel: addrSnippet });
          seenIds.add(agent.id);
        }
        if (results.length >= 20) break;
      }

      return results.slice(0, 12);
    }

    const showSuggestions = debounce(val => {
      if (val.length < 2 || compareIds.length >= 3) { suggestionsEl.classList.remove('open'); return; }
      const matches = findAgentMatches(val);
      if (!matches.length) { suggestionsEl.classList.remove('open'); return; }

      let lastVia = '';
      suggestionsEl.innerHTML = matches.map(m => {
        const a = m.agent;
        const icon = m.via === 'postcode' ? SICONS.pin : m.via === 'area' ? SICONS.map : m.via === 'address' ? SICONS.home : SICONS.building;
        let sep = '';
        if (m.via !== lastVia) {
          lastVia = m.via;
          const labels = { postcode: 'By Postcode', area: 'By Area', name: 'By Name', address: 'By Address' };
          sep = `<div class="suggestion-divider">${labels[m.via] || m.via}</div>`;
        }
        return `${sep}<div class="suggestion-item" data-id="${a.id}">
          ${icon}
          <span class="suggestion-text">${a.name}</span>
          <span class="suggestion-sub">${a.postcode || a.outcode || ''}</span>
          <span class="suggestion-meta"><span class="suggestion-type">${m.viaLabel || (a.postcode || '')}</span></span>
        </div>`;
      }).join('');
      suggestionsEl.classList.add('open');

      suggestionsEl.querySelectorAll('.suggestion-item').forEach(item => {
        item.addEventListener('click', () => {
          const id = parseInt(item.dataset.id);
          if (compareIds.length < 3 && !compareIds.includes(id)) {
            if (isSample) {
              isSample = false;
              document.getElementById('sample-banner').style.display = 'none';
            }
            compareIds.push(id);
            lsSet('af_compare', compareIds);
            renderSlots();
            renderComparison();
          }
          searchInput.value = '';
          suggestionsEl.classList.remove('open');
        });
      });
    }, 200);

    searchInput.addEventListener('input', e => showSuggestions(e.target.value));
    document.addEventListener('click', e => {
      if (!e.target.closest('.search-wrapper')) suggestionsEl.classList.remove('open');
    });

    // ===== Smart Filters =====
    const activeFilters = {
      location: null,
      trustMin: null,
      hasFees: false,
      hasReviews: false,
      arla: false,
      cmp: false,
      category: null,
      experience: null,
    };
    let cfSortBy = 'trust';
    let cfPage = 1;
    const CF_PER_PAGE = 12;

    function hasActiveFilters() {
      return activeFilters.location || activeFilters.trustMin || activeFilters.hasFees ||
        activeFilters.hasReviews || activeFilters.arla || activeFilters.cmp ||
        activeFilters.category || activeFilters.experience;
    }

    function applyFilters() {
      if (!data || !data.agents) return [];

      let locationIds = null;
      if (activeFilters.location) {
        const loc = activeFilters.location;
        if (loc.type === 'outcode') {
          const ids = data.postcodeIndex[loc.value];
          locationIds = ids ? new Set(ids) : new Set();
        } else if (loc.type === 'area') {
          const ids = data.areaIndex[loc.value];
          locationIds = ids ? new Set(ids) : new Set();
        } else if (loc.type === 'prefix') {
          const allIds = new Set();
          for (const [outcode, ids] of Object.entries(data.postcodeIndex)) {
            if (outcode.startsWith(loc.value)) ids.forEach(id => allIds.add(id));
          }
          locationIds = allIds;
        }
      }

      return data.agents.filter(a => {
        if (compareIds.includes(a.id)) return false;
        if (locationIds && !locationIds.has(a.id)) return false;
        if (activeFilters.trustMin && a.trust_score < activeFilters.trustMin) return false;
        if (activeFilters.hasFees && !(a.fees.tenant_find || a.fees.full_management || a.fees.mgmt_pct || a.fees.detail)) return false;
        if (activeFilters.hasReviews && !a.reviews.avg) return false;
        if (activeFilters.arla && !a.regulatory.arla) return false;
        if (activeFilters.cmp && !a.regulatory.cmp) return false;
        if (activeFilters.category) {
          if (activeFilters.category === 'letting' && a.category !== 'letting' && a.category !== 'both') return false;
          if (activeFilters.category === 'estate' && a.category !== 'estate' && a.category !== 'both') return false;
          if (activeFilters.category === 'both' && a.category !== 'both') return false;
        }
        if (activeFilters.experience && a.experience !== activeFilters.experience) return false;
        return true;
      });
    }

    function sortFiltered(agents) {
      const arr = [...agents];
      switch (cfSortBy) {
        case 'trust': arr.sort((a, b) => b.trust_score - a.trust_score); break;
        case 'rating': arr.sort((a, b) => (b.reviews.avg || 0) - (a.reviews.avg || 0)); break;
        case 'name': arr.sort((a, b) => a.name.localeCompare(b.name)); break;
        case 'fees': arr.sort((a, b) => (a.fees.mgmt_pct || 999) - (b.fees.mgmt_pct || 999)); break;
      }
      return arr;
    }

    function renderFilteredResults() {
      const panel = document.getElementById('cf-results-panel');
      const grid = document.getElementById('cf-results-grid');
      const countEl = document.getElementById('cf-results-count');
      const moreWrap = document.getElementById('cf-results-more');
      const fullMsg = document.getElementById('cf-slots-full');
      const clearBtn = document.getElementById('cf-clear-all');

      if (compareIds.length >= 3) {
        panel.style.display = 'none';
        fullMsg.style.display = hasActiveFilters() ? '' : 'none';
        return;
      }
      fullMsg.style.display = 'none';

      if (!hasActiveFilters()) {
        panel.style.display = 'none';
        clearBtn.style.display = 'none';
        return;
      }
      clearBtn.style.display = '';

      const matched = applyFilters();
      const sorted = sortFiltered(matched);
      const visible = sorted.slice(0, cfPage * CF_PER_PAGE);

      countEl.textContent = `${matched.length} agent${matched.length !== 1 ? 's' : ''} match`;
      panel.style.display = '';

      if (!matched.length) {
        grid.innerHTML = '<div style="padding:var(--sp-6);text-align:center;color:var(--text-muted);grid-column:1/-1">No agents match your current filters. Try adjusting your criteria.</div>';
        moreWrap.style.display = 'none';
        return;
      }

      grid.innerHTML = visible.map(a => {
        const trustCls = trustScoreClass(a.trust_score);
        const badges = [];
        if (a.regulatory.arla) badges.push('<span class="cf-rc-badge cf-rc-badge-arla">ARLA</span>');
        if (a.fees.mgmt_pct) badges.push(`<span class="cf-rc-badge cf-rc-badge-fee">${a.fees.mgmt_pct}%</span>`);
        else if (a.fees.tenant_find || a.fees.full_management) badges.push('<span class="cf-rc-badge cf-rc-badge-fee">Fees</span>');
        const alreadyAdded = compareIds.includes(a.id);
        return `<div class="cf-result-card${alreadyAdded ? ' disabled' : ''}" data-agent-id="${a.id}">
          <div class="trust-score ${trustCls} trust-score-sm" style="flex-shrink:0">${a.trust_score}</div>
          <div class="cf-rc-info">
            <div class="cf-rc-name" title="${a.name}">${a.name}</div>
            <div class="cf-rc-meta">
              <span>${a.postcode || a.outcode || ''}</span>
              ${badges.join('')}
            </div>
          </div>
          <button class="cf-rc-add" ${alreadyAdded ? 'disabled' : ''}>+ Add</button>
        </div>`;
      }).join('');

      moreWrap.style.display = visible.length < sorted.length ? '' : 'none';

      grid.querySelectorAll('.cf-rc-add').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const card = e.target.closest('.cf-result-card');
          const id = parseInt(card.dataset.agentId);
          if (compareIds.length < 3 && !compareIds.includes(id)) {
            if (isSample) {
              isSample = false;
              document.getElementById('sample-banner').style.display = 'none';
            }
            compareIds.push(id);
            lsSet('af_compare', compareIds);
            renderSlots();
            renderComparison();
            renderFilteredResults();
          }
        });
      });
    }

    // Update chip active states
    function updateChipStates() {
      document.querySelectorAll('.cf-toggle').forEach(chip => {
        const key = chip.dataset.filter;
        chip.classList.toggle('active', !!activeFilters[key]);
      });
      const locChip = document.querySelector('[data-filter="location"]');
      if (locChip) locChip.classList.toggle('active', !!activeFilters.location);
      const trustChip = document.querySelector('[data-filter="trust"]');
      if (trustChip) trustChip.classList.toggle('active', !!activeFilters.trustMin);
      const catChip = document.querySelector('[data-filter="category"]');
      if (catChip) catChip.classList.toggle('active', !!activeFilters.category);
      const expChip = document.querySelector('[data-filter="experience"]');
      if (expChip) expChip.classList.toggle('active', !!activeFilters.experience);
    }

    // Toggle chips (Has Fees, Has Reviews, ARLA, CMP)
    document.querySelectorAll('.cf-toggle').forEach(chip => {
      chip.addEventListener('click', () => {
        const key = chip.dataset.filter;
        activeFilters[key] = !activeFilters[key];
        cfPage = 1;
        updateChipStates();
        renderFilteredResults();
      });
    });

    // Dropdown chips
    function closeAllDropdowns() {
      document.querySelectorAll('.cf-dropdown').forEach(dd => dd.classList.remove('open'));
    }

    document.querySelectorAll('.cf-chip-wrap > .cf-chip').forEach(chip => {
      chip.addEventListener('click', (e) => {
        e.stopPropagation();
        const wrap = chip.closest('.cf-chip-wrap');
        const dd = wrap.querySelector('.cf-dropdown');
        const isOpen = dd.classList.contains('open');
        closeAllDropdowns();
        if (!isOpen) dd.classList.add('open');
      });
    });

    document.addEventListener('click', (e) => {
      if (!e.target.closest('.cf-chip-wrap')) closeAllDropdowns();
    });

    // Location dropdown — enhanced search (postcodes + area names)
    const locSearch = document.getElementById('loc-search');
    const locList = document.getElementById('loc-list');

    function renderLocList(q) {
      if (!data) return;
      const raw = (q || '').trim();
      const qUp = raw.toUpperCase();
      const qLow = raw.toLowerCase();
      const hasDigit = /\d/.test(raw);
      let html = '';

      const PIN_ICON = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:13px;height:13px;vertical-align:-2px;margin-right:4px;opacity:.5"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>';
      const MAP_ICON = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:13px;height:13px;vertical-align:-2px;margin-right:4px;opacity:.5"><polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"/><line x1="8" y1="2" x2="8" y2="18"/><line x1="16" y1="6" x2="16" y2="22"/></svg>';

      // Areas & Cities — shown by default and when typing letters
      if (data.areaIndex) {
        const areaMatches = Object.entries(data.areaIndex)
          .filter(([area]) => {
            if (area.length <= 2) return false;
            if (!raw) return true;
            return qLow.length <= 3
              ? area.startsWith(qLow) || area.includes(' ' + qLow)
              : area.includes(qLow);
          })
          .sort((a, b) => b[1].length - a[1].length)
          .slice(0, raw ? 10 : 15);

        if (areaMatches.length) {
          html += '<div class="cf-dd-section">Areas &amp; Cities</div>';
          html += areaMatches.map(([area, ids]) => {
            const title = area.replace(/\b\w/g, c => c.toUpperCase());
            return `<div class="cf-dd-item" data-loc-type="area" data-loc-value="${area}">
              <span>${MAP_ICON}${title}</span>
              <span class="cf-dd-item-count">${ids.length} agents</span>
            </div>`;
          }).join('');
        }
      }

      // Postcode matches — shown when user types something (especially with digits)
      if (data.postcodeIndex && raw.length >= 1) {
        const pcMatches = Object.entries(data.postcodeIndex)
          .filter(([k]) => k.startsWith(qUp))
          .sort((a, b) => b[1].length - a[1].length)
          .slice(0, hasDigit ? 10 : 6);

        if (pcMatches.length) {
          html += '<div class="cf-dd-section">Postcodes</div>';
          html += pcMatches.map(([outcode, ids]) =>
            `<div class="cf-dd-item" data-loc-type="outcode" data-loc-value="${outcode}">
              <span>${PIN_ICON}${outcode}</span>
              <span class="cf-dd-item-count">${ids.length} agents</span>
            </div>`
          ).join('');
        }
      }

      // Prefix hint when typing letters only, no exact outcode match
      if (raw.length >= 2 && /^[A-Za-z]+$/.test(raw) && !data.postcodeIndex[qUp]) {
        const prefixCount = Object.entries(data.postcodeIndex)
          .filter(([k]) => k.startsWith(qUp))
          .reduce((sum, [, ids]) => sum + ids.length, 0);
        if (prefixCount > 0) {
          html += `<div class="cf-dd-item cf-dd-item-highlight" data-loc-type="prefix" data-loc-value="${qUp}">
            <span>All <strong>${qUp}*</strong> postcodes</span>
            <span class="cf-dd-item-count">${prefixCount} agents</span>
          </div>`;
        }
      }

      if (!html) {
        html = '<div style="padding:10px 12px;font-size:0.78rem;color:var(--text-muted);text-align:center">No matching locations found</div>';
      }

      locList.innerHTML = html;

      locList.querySelectorAll('.cf-dd-item').forEach(item => {
        item.addEventListener('click', () => {
          const locType = item.dataset.locType;
          const locValue = item.dataset.locValue;
          activeFilters.location = { type: locType, value: locValue };

          const chip = document.querySelector('[data-filter="location"] span');
          if (locType === 'outcode') {
            chip.textContent = locValue;
          } else if (locType === 'area') {
            chip.textContent = locValue.replace(/\b\w/g, c => c.toUpperCase());
          } else if (locType === 'prefix') {
            chip.textContent = locValue + '*';
          }

          cfPage = 1;
          closeAllDropdowns();
          updateChipStates();
          renderFilteredResults();
        });
      });
    }

    locSearch.addEventListener('input', () => renderLocList(locSearch.value));
    locSearch.addEventListener('click', (e) => e.stopPropagation());
    renderLocList('');

    // Trust score radio
    document.querySelectorAll('input[name="cf-trust"]').forEach(radio => {
      radio.addEventListener('change', () => {
        activeFilters.trustMin = radio.value ? parseInt(radio.value) : null;
        const chip = document.querySelector('[data-filter="trust"] span');
        if (chip) chip.textContent = radio.value ? `Trust ${radio.value}+` : 'Trust Score';
        cfPage = 1;
        closeAllDropdowns();
        updateChipStates();
        renderFilteredResults();
      });
    });

    // Category radio
    document.querySelectorAll('input[name="cf-cat"]').forEach(radio => {
      radio.addEventListener('change', () => {
        activeFilters.category = radio.value || null;
        const chip = document.querySelector('[data-filter="category"] span');
        const labels = { letting: 'Lettings', estate: 'Estate', both: 'Both' };
        if (chip) chip.textContent = radio.value ? labels[radio.value] : 'Category';
        cfPage = 1;
        closeAllDropdowns();
        updateChipStates();
        renderFilteredResults();
      });
    });

    // Experience radio
    document.querySelectorAll('input[name="cf-exp"]').forEach(radio => {
      radio.addEventListener('change', () => {
        activeFilters.experience = radio.value || null;
        const chip = document.querySelector('[data-filter="experience"] span');
        const labels = { growing: 'Growing', established: 'Established', veteran: 'Veteran' };
        if (chip) chip.textContent = radio.value ? labels[radio.value] : 'Experience';
        cfPage = 1;
        closeAllDropdowns();
        updateChipStates();
        renderFilteredResults();
      });
    });

    // Sort control
    document.getElementById('cf-sort').addEventListener('change', (e) => {
      cfSortBy = e.target.value;
      cfPage = 1;
      renderFilteredResults();
    });

    // Show more button
    document.getElementById('cf-show-more').addEventListener('click', () => {
      cfPage++;
      renderFilteredResults();
    });

    // Clear all filters
    document.getElementById('cf-clear-all').addEventListener('click', () => {
      activeFilters.location = null;
      activeFilters.trustMin = null;
      activeFilters.hasFees = false;
      activeFilters.hasReviews = false;
      activeFilters.arla = false;
      activeFilters.cmp = false;
      activeFilters.category = null;
      activeFilters.experience = null;
      cfPage = 1;

      // Reset chip labels
      const locSpan = document.querySelector('[data-filter="location"] span');
      if (locSpan) locSpan.textContent = 'Location';
      const trustSpan = document.querySelector('[data-filter="trust"] span');
      if (trustSpan) trustSpan.textContent = 'Trust Score';
      const catSpan = document.querySelector('[data-filter="category"] span');
      if (catSpan) catSpan.textContent = 'Category';
      const expSpan = document.querySelector('[data-filter="experience"] span');
      if (expSpan) expSpan.textContent = 'Experience';

      // Reset radios
      document.querySelectorAll('.cf-dropdown input[type="radio"][value=""]').forEach(r => r.checked = true);
      locSearch.value = '';
      renderLocList('');

      updateChipStates();
      renderFilteredResults();
    });

    // Re-render filters when agents are added/removed
    const _origRenderSlots = renderSlots;
    const _origRenderComparison = renderComparison;

    // Show sample banner if applicable
    if (isSample) {
      document.getElementById('sample-banner').style.display = '';
      document.getElementById('clear-sample-btn').addEventListener('click', () => {
        compareIds = [];
        isSample = false;
        lsSet('af_compare', []);
        document.getElementById('sample-banner').style.display = 'none';
        renderSlots();
        renderComparison();
        document.getElementById('agent-search').focus();
      });
    }

    // Hide sample banner when user manually adds/removes agents
    const origRemove = window.removeAgent;

    window.removeAgent = (index) => {
      compareIds.splice(index, 1);
      if (isSample) {
        isSample = false;
        document.getElementById('sample-banner').style.display = 'none';
      }
      lsSet('af_compare', compareIds);
      renderSlots();
      renderComparison();
      renderFilteredResults();
    };

    // Initial render
    renderSlots();
    renderComparison();
  </script>

</body>
</html>
